{% extends "base.html" %}
{% load static %}


{% block body %}
    <div class="container">

        <h1>Validation de fichier de modification de profils et sous-profils</h1>


        <div class="card border-primary my-3">
            <div class="card-body">
                <p class="text-primary">Ce formulaire vous permet de v√©rifier le format et les donn√©es des fichiers
                    de modification en masse des profils et sous profils d'√©tablissement de Trackd√©chets avant de les
                    transmettre √† l'√©quipe de support.
                </p>
                <p class="text-primary">
                    Merci de vous r√©f√©rer aux indications de <a
                        href="https://faq.trackdechets.fr/informations-generiques/sinscrire/je-cree-de-compte/creer-des-comptes-en-masse">la
                    faq Trackd√©chets</a> et notamment d'utiliser le mod√®le de fichier fourni sans en modifier les
                    intitul√©s de colonnes et onglets.
                </p>
                <p class="text-primary">En de√ßa du nombre minimal d'√©tablissements requis, merci d'effectuer les
                    modifications de comptes manuellement.</p>
                
            </div>
        </div>

        {% if not has_errors and form %}
            <form action="" method="post" enctype="multipart/form-data">
                {% csrf_token %}
                {% include "_form_snippet.html" with form=form %}
                <p>Ce formulaire analyse votre fichier, aucune donn√©e ne sera import√©e dans Trackd√©chets ni stock√©e sur
                    ce serveur</p>
                <button type="submit" class="btn btn-primary">Analyser et valider mon fichier</button>

            </form>
        {% endif %}



        {% if has_errors %}
            <p><a href="{% url "validate_update_file" %}">Valider un autre fichier</a></p>
        {% endif %}

        {% if success %}
            <div class="card border-primary my-3">
                <div class="card-body">
                    <p class="text-primary">
                        üëç Votre fichier est valide !
                    </p>
                    <p class="text-primary">
                        Vous pouvez le transmettre √† l'adresse contact@trackdechets.beta.gouv.fr o√π
                        il sera import√©, en pr√©cisant que la validation a √©t√© effectu√©e.
                    </p>
                    <p class="text-primary">
                        Si vous deviez le modifier, merci de le valider √† nouveau avant envoi.
                    </p>
                           {% if  json_export %}
                               <p>Vous pouvez copier-coller le contenu ci-dessous dans le champ appropri√© de l'admin Trackd√©chets</p>
            <textarea style="border: 1px solid black" cols="100"  rows="30">
                {{ json_export }}
            </textarea>
        {% endif %}
                </div>
            </div>
        {% endif %}

        {% if enough_rows_error %}
            <div class="card border-danger my-3">
                <div class="card-body text-danger">
                    <p>
                        <strong>Votre fichier ne comporte pas le nombre minimal d'√©tablissements pour √™tre
                            import√©</strong>
                    </p>
                    <p>
                        L'import en masse √©tant g√©r√© par nos √©quipes, nous traitons uniquement les imports cons√©quents.
                    </p>
                    <p>Merci d'effectuer les cr√©ations de comptes manuellement</p>

                </div>
            </div>
        {% endif %}

        {% if too_many_rows_error %}
            <div class="card border-danger my-3">
                <div class="card-body text-danger">
                    <p>
                        <strong>Votre fichier comporte trop d'√©tablissements, le maximum √©tant de 500 pour des raisons
                            techniques</strong>
                    </p>

                    <p>Merci de d√©couper votre fichier en plusieurs comportant au maximum 500 √©tablissements</p>

                </div>
            </div>
        {% endif %}

        {% if parse_error %}
            <div class="card border-danger my-3">
                <div class="card-body text-danger">
                    <p>
                        <strong>Le format de votre fichier ou son contenu n'est pas reconnu.</strong>
                    </p>

                    <p>
                        Veuillez v√©rifier les points suivants :
                    </p>
                    <ul>

                        <li>Le seul format que nous acceptons est le xlsx.</li>
                        <li>Veuillez utiliser le gabarit t√©l√©chargeable sur <a
                                href="https://faq.trackdechets.fr/informations-generiques/sinscrire/je-cree-de-compte/creer-des-comptes-en-masse ">la
                            faq</a>
                        </li>
                        <li>Supprimez les lignes d'exemples du gabarit</li>
                        <li>Ne modifiez pas les en-t√™tes de colonne, les noms ou l'ordre des onglets</li>
                        <li>N'ajoutez pas de colonne</li>
                        <li>Certains logiciels peuvent g√©n√©rer des fichiers xlsx que nous n'arrivons pas √† lire, vous
                            pouvez tenter de copier/coller la feuille xlsx dans un nouveau fichier xlsx en s√©l√©ctionant
                            "collage sp√©cial > valeurs"
                        </li>

                    </ul>

                </div>
            </div>

        {% endif %}


        {% if errors %}
            <div class="card border-danger my-3">
                <div class="card-body text-danger">
                    <p>
                        Votre fichier comporte une ou plusieurs erreurs
                    </p>
                    <p>Notre syst√®me informatique ne sera pas en mesure de l'importer</p>
                    <p>Veuillez corriger les erreurs, et v√©rifier √† nouveau la validit√© de votre fichier avant de le
                        faire parvenir √† l'√©quipe de support</p>


                </div>
            </div>
            <table class="table table-bordered table-hover">
            <thead>
            <tr class="text-danger">
                <th scope="col">Onglet</th>
                <th scope="col">Num√©ro de ligne</th>
                <th scope="col">Colonne</th>
                <th scope="col">Valeur</th>
                <th scope="col">Erreur</th>

            </tr>
            </thead>
            <tbody>
            {% for error in errors %}

                <tr class="text-danger">

                    <td> {{ error.tab }}</td>
                    <td> {{ error.row_number }}</td>
                    <td> {{ error.field_name }}</td>
                    <td> {{ error.displayable_value }}</td>
                    <td> {{ error.verbose }}</td>
                </tr>
                </tbody>
            {% endfor %}
        {% endif %}
        </table>
    </div>
{% endblock %}
